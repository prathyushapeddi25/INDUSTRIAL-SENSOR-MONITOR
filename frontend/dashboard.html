<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fermenter Monitor - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-value.anomaly {
            color: #f56565;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .tag-selector {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
        }

        .anomalies-list {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 500px;
            overflow-y: auto;
        }

        .anomaly-item {
            padding: 12px;
            border-left: 4px solid #f56565;
            background: #fff5f5;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .anomaly-tag {
            font-weight: bold;
            color: #c53030;
            font-size: 14px;
        }

        .anomaly-value {
            font-size: 13px;
            color: #333;
            margin-top: 5px;
        }

        .anomaly-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-indicator.active {
            background: #48bb78;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .no-data {
            text-align: center;
            color: #999;
            padding: 40px;
        }

        .refresh-info {
            font-size: 12px;
            color: #999;
            text-align: right;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ§« Fermenter Monitoring Dashboard</h1>
            <p class="subtitle">
                <span class="status-indicator active"></span>
                Real-time monitoring with anomaly detection
            </p>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Tags</div>
                <div class="stat-value" id="stat-tags">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Measurements</div>
                <div class="stat-value" id="stat-measurements">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Anomalies Detected</div>
                <div class="stat-value anomaly" id="stat-anomalies">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Anomaly Rate</div>
                <div class="stat-value anomaly" id="stat-rate">0%</div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">Time-Series Data</h2>
                    <select id="tag-selector" class="tag-selector">
                        <option value="">Loading tags...</option>
                    </select>
                </div>
                <canvas id="dataChart"></canvas>
                <p class="refresh-info">Auto-refreshing every 5 seconds</p>
            </div>

            <div class="anomalies-list">
                <h2 class="chart-title">Recent Anomalies</h2>
                <div id="anomalies-container">
                    <div class="no-data">No anomalies detected yet</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let chart = null;
        let currentTag = null;

        // Initialize chart
        function initChart() {
            const ctx = document.getElementById('dataChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Measurement Value',
                            data: [],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'Anomalies',
                            data: [],
                            borderColor: '#f56565',
                            backgroundColor: '#f56565',
                            borderWidth: 0,
                            pointRadius: 8,
                            pointStyle: 'triangle',
                            showLine: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time'
                            },
                            ticks: {
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Value'
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        // Load tags using GET /tags
        async function loadTags() {
            try {
                const response = await fetch(`${API_BASE}/tags`);
                const data = await response.json();
                const tags = data.tags || [];
                
                const selector = document.getElementById('tag-selector');
                selector.innerHTML = tags.map(tag => 
                    `<option value="${tag}">${tag}</option>`
                ).join('');
                
                if (tags.length > 0 && !currentTag) {
                    currentTag = tags[0];
                    selector.value = currentTag;
                    await loadData();
                }
            } catch (error) {
                console.error('Error loading tags:', error);
            }
        }

        // Load data for selected tag using GET /data
        async function loadData() {
            if (!currentTag) return;

            try {
                // Get all data for the tag
                const response = await fetch(`${API_BASE}/data?tag=${currentTag}`);
                const measurements = await response.json();
                
                // Reverse to show chronological order
                measurements.reverse();
                
                // Update chart - limit to last 100 points for readability
                const recentMeasurements = measurements.slice(-100);
                const labels = recentMeasurements.map(m => new Date(m.timestamp).toLocaleTimeString());
                const values = recentMeasurements.map(m => m.value);
                
                // Mark anomalies
                const anomalyPoints = recentMeasurements.map(m => 
                    m.is_anomaly ? m.value : null
                );
                
                chart.data.labels = labels;
                chart.data.datasets[0].data = values;
                chart.data.datasets[1].data = anomalyPoints;
                chart.update();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Load statistics using GET /stats
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                const stats = await response.json();
                
                document.getElementById('stat-tags').textContent = stats.total_tags || 0;
                document.getElementById('stat-measurements').textContent = stats.total_measurements || 0;
                document.getElementById('stat-anomalies').textContent = stats.total_anomalies || 0;
                document.getElementById('stat-rate').textContent = `${stats.anomaly_rate || 0}%`;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load recent anomalies
        async function loadAnomalies() {
            try {
                // Get anomalies for all tags
                const tags = ['fermenter_temp', 'fermenter_ph', 'agitator_rpm'];
                let allAnomalies = [];
                
                for (const tag of tags) {
                    try {
                        const response = await fetch(`${API_BASE}/anomalies?tag=${tag}`);
                        const anomalies = await response.json();
                        allAnomalies = allAnomalies.concat(anomalies);
                    } catch (e) {
                        // Tag might not have data yet
                    }
                }
                
                // Sort by timestamp descending
                allAnomalies.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                const container = document.getElementById('anomalies-container');
                
                if (allAnomalies.length === 0) {
                    container.innerHTML = '<div class="no-data">No anomalies detected yet</div>';
                    return;
                }
                
                // Show only the 20 most recent
                const recentAnomalies = allAnomalies.slice(0, 20);
                
                container.innerHTML = recentAnomalies.map(anomaly => `
                    <div class="anomaly-item">
                        <div class="anomaly-tag">${anomaly.tag}</div>
                        <div class="anomaly-value">Value: ${anomaly.value.toFixed(2)}</div>
                        <div class="anomaly-time">
                            ${new Date(anomaly.timestamp).toLocaleString()}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading anomalies:', error);
            }
        }

        // Tag selector change handler
        document.getElementById('tag-selector').addEventListener('change', async (e) => {
            currentTag = e.target.value;
            await loadData();
        });

        // Initialize dashboard
        async function init() {
            initChart();
            await loadTags();
            await loadStats();
            await loadAnomalies();
            
            // Auto-refresh every 5 seconds
            setInterval(async () => {
                await loadData();
                await loadStats();
                await loadAnomalies();
            }, 5000);
        }

        // Start the dashboard
        init();
    </script>
</body>
</html>
